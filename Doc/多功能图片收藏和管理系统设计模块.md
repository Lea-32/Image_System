# 多功能图片收藏和管理系统设计模块

## 1. 系统总体设计

### 1.1 系统架构概述

多功能图片收藏和管理系统采用B/S架构，基于Flask框架开发的Web应用程序，遵循MVC设计模式。系统分为前端表现层、应用逻辑层和数据持久层三个主要部分，通过分层设计提高了系统的模块化程度和可维护性。

### 1.2 系统结构图

```
+------------------------------------------+
|                                          |
|              表现层(前端)                 |
|                                          |
|  +------------+      +---------------+   |
|  |   HTML/    |      |   静态资源    |   |
|  |   Jinja2   |      | (CSS/JS/图片) |   |
|  +------------+      +---------------+   |
|         |                   |            |
+---------|-------------------|-----------+
          |                   |
+---------|-------------------|-----------+
|         v                   v            |
|              应用逻辑层                   |
|                                          |
|  +------------+      +---------------+   |
|  |   路由控制  |----->|  业务逻辑处理  |   |
|  +------------+      +---------------+   |
|        |  ^                |  ^          |
|        |  |                |  |          |
|        v  |                v  |          |
|  +------------+      +---------------+   |
|  | 数据验证/  |      |    工具类库    |   |
|  | 表单处理   |      | (图像处理/推荐) |   |
|  +------------+      +---------------+   |
|         |                   |            |
+---------|-------------------|-----------+
          |                   |
+---------|-------------------|-----------+
|         v                   v            |
|              数据持久层                   |
|                                          |
|  +-----------------+  +---------------+  |
|  |  数据访问接口   |--|    SQL Server  |  |
|  +-----------------+  |    数据库      |  |
|                       +---------------+  |
|  +-----------------+                     |
|  |   文件存储系统   |                     |
|  |  (图片文件存储)  |                     |
|  +-----------------+                     |
|                                          |
+------------------------------------------+
```

### 1.3 系统功能模块图

```
+--------------------------------------------------------------+
|                                                              |
|               多功能图片收藏和管理系统                         |
|                                                              |
+--------------------------------------------------------------+
          |          |           |           |           |
          v          v           v           v           v
+-------------+ +----------+ +---------+ +----------+ +----------+
| 用户账户管理 | | 图片管理 | | 收藏夹  | | 标签系统 | | 社交互动 |
+-------------+ +----------+ | 管理    | +----------+ +----------+
| - 用户注册   | | - 图片上传| +---------+ | - 标签添加| | - 评论   |
| - 用户登录   | | - 图片查看| | - 收藏夹 | | - 标签搜索| | - 点赞   |
| - 密码管理   | | - 图片编辑| |   创建   | | - 自动标签| | - 收藏   |
| - 权限控制   | | - 图片删除| | - 图片收藏| |   生成   | | - 分享   |
+-------------+ +----------+ +---------+ +----------+ +----------+
                     |                                     |
                     v                                     v
              +---------------+                    +---------------+
              | 图像处理子系统 |                    | 推荐系统子系统 |
              +---------------+                    +---------------+
              | - 元数据提取   |                    | - 协同过滤    |
              | - 缩略图生成   |                    | - 内容推荐    |
              | - 图像识别     |                    | - 热门推荐    |
              | - 特征提取     |                    | - 相似图片    |
              +---------------+                    +---------------+
                                    |
                                    v
                            +----------------+
                            | 搜索子系统      |
                            +----------------+
                            | - 全文搜索      |
                            | - 标签过滤      |
                            | - 高级搜索      |
                            | - 相似图片搜索   |
                            +----------------+
```

## 2. 系统类图设计

### 2.1 系统类图概述

系统类图展示了系统中主要类及其之间的关系，为了简化表示，这里仅给出类名称和它们之间的关系。

### 2.2 核心类图

```
+----------------+       +----------------+       +----------------+
|      User      |<----->|     Image      |<----->|      Tag       |
+----------------+       +----------------+       +----------------+
| - user_id      |       | - img_id       |       | - tag_id       |
| - user_name    |       | - img_path     |       | - tag_name     |
| - user_password|       | - upload_time  |       +----------------+
| - user_email   |       | - user_id      |              ^
| - admin        |       +----------------+              |
+----------------+              ^                        |
       ^                        |                        |
       |                        |                        |
       |                        |                        |
       v                        v                        v
+----------------+       +----------------+       +----------------+
|  FavoriteFolder|<----->|ImageFavorite   |       |   TagIndex    |
+----------------+       |   Folder       |       +----------------+
| - folder_id    |       +----------------+       | - img_id       |
| - user_id      |       | - img_id       |       | - tag_id       |
| - folder_name  |       | - folder_id    |       +----------------+
| - folder_desc  |       +----------------+
+----------------+
       ^
       |
       |
       v
+----------------+       +----------------+       +----------------+
|    Favorite    |       |    Comment     |       | View_History   |
+----------------+       +----------------+       +----------------+
| - favorite_id  |       | - comment_id   |       | - view_id      |
| - user_id      |       | - content      |       | - user_id      |
| - img_id       |       | - user_id      |       | - img_id       |
+----------------+       | - img_id       |       | - view_time    |
                        | - release_time  |       +----------------+
                        +----------------+
```

### 2.3 推荐系统相关类图

```
+----------------+       +----------------+       +----------------+
| UserSimilarity |       |ImageSimilarity |       |UserRecommend   |
+----------------+       +----------------+       |  ations        |
| - user_id1     |       | - img_id1      |       +----------------+
| - user_id2     |       | - img_id2      |       | - user_id      |
| - similarity   |       | - similarity   |       | - img_id       |
| - update_time  |       | - update_time  |       | - score        |
+----------------+       +----------------+       | - update_time  |
                                                 +----------------+
```

### 2.4 类之间的关系

1. **关联关系**：
   - User 与 Image：一对多关系，一个用户可以上传多张图片
   - User 与 FavoriteFolder：一对多关系，一个用户可以创建多个收藏夹
   - User 与 Comment：一对多关系，一个用户可以发表多条评论
   - Image 与 Comment：一对多关系，一张图片可以有多条评论

2. **聚合关系**：
   - FavoriteFolder 聚合 ImageFavoriteFolder：收藏夹包含多个图片引用
   - User 聚合 Favorite：用户包含多个收藏记录
   - User 聚合 View_History：用户包含多个浏览记录

3. **多对多关系**：
   - Image 与 Tag：通过 TagIndex 实现多对多关系
   - Image 与 FavoriteFolder：通过 ImageFavoriteFolder 实现多对多关系

## 3. 数据库设计

### 3.1 E-R图

```
                    +------------+
                    |    User    |
                    +------------+
                    | PK user_id |
                    | user_name  |
                    | password   |
                    | email      |
                    | admin      |
                    +------------+
                        |  |
                        |  |
           +------------+  +------------+
           |                            |
           v                            v
   +---------------+            +----------------+
   |    Image      |            | FavoriteFolder |
   +---------------+            +----------------+
   | PK img_id     |<---------o| PK folder_id   |
   | img_path      |            | folder_name    |
   | upload_time   |            | description    |
   | FK user_id    |            | FK user_id     |
   | width         |            | is_default     |
   | height        |            | create_time    |
   | format        |            +----------------+
   | description   |                    |
   | name          |                    |
   | view_count    |                    |
   +---------------+                    |
        |     |                         |
        |     |                         |
        |     +-----------+             |
        |                 |             |
        v                 v             v
  +----------+    +-------------+    +-----------------+
  |   Tag    |    |   Comment   |    |ImageFavorite    |
  +----------+    +-------------+    |    Folder       |
  | PK tag_id|    | PK comment_id    +-----------------+
  | tag_name |    | content     |    | PK,FK img_id    |
  +----------+    | release_time|    | PK,FK folder_id |
        |         | FK user_id  |    | img_order       |
        |         | FK img_id   |    | add_time        |
        |         +-------------+    +-----------------+
        |
        v
  +-------------+
  | Tag_index   |
  +-------------+
  | PK,FK img_id|
  | PK,FK tag_id|
  +-------------+
```

### 3.2 E-R图向关系模式的转换

根据E-R图，我们可以将实体和关系转换为关系模式：

1. 实体转换为关系：
   - User(user_id, user_name, user_password, user_email, admin)
   - Image(img_id, img_path, upload_time, user_id, width, height, format, description, name, view_count)
   - Tag(tag_id, tag_name)
   - Comment(comment_id, content, release_time, user_id, img_id)
   - FavoriteFolder(folder_id, user_id, folder_name, description, is_default, create_time)

2. 多对多关系转换为关系：
   - Tag_index(img_id, tag_id)
   - ImageFavoriteFolder(img_id, folder_id, img_order, add_time)

3. 额外的关系：
   - Favorite(favorite_id, user_id, img_id)
   - View_History(view_id, user_id, img_id, view_time)
   - UserSimilarity(user_id1, user_id2, similarity_score, update_time)
   - ImageSimilarity(img_id1, img_id2, similarity_score, update_time)
   - UserRecommendations(user_id, img_id, score, update_time)

### 3.3 关系的范式分解

检查上述关系是否满足第三范式要求：

1. **第一范式**：所有关系都满足第一范式，因为所有属性都是原子的。

2. **第二范式**：
   - 所有具有单一主键的关系自动满足第二范式。
   - 对于复合主键的关系(Tag_index, ImageFavoriteFolder)，需确保非主键属性完全依赖于主键。
   
3. **第三范式**：需确保没有非主键属性传递依赖于主键。

经过分析，所有关系基本满足第三范式。以下是最终的数据库表设计：

### 3.4 数据库表设计

#### Users表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| user_id | int | PRIMARY KEY | 用户ID |
| user_name | varchar(100) | NOT NULL | 用户名 |
| user_password | varchar(50) | NULL | 密码 |
| user_email | varchar(50) | NULL | 邮箱 |
| admin | bit | NOT NULL | 是否管理员 |

#### Image表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| img_id | int | PRIMARY KEY | 图片ID |
| img_width | int | NOT NULL | 图片宽度 |
| img_height | int | NOT NULL | 图片高度 |
| img_format | char(4) | NOT NULL | 图片格式 |
| img_upload_time | date | NOT NULL | 上传时间 |
| img_path | varchar(50) | NOT NULL | 存储路径 |
| user_id | int | FOREIGN KEY | 上传用户ID |
| img_name | varchar(100) | NULL | 图片名称 |
| img_description | varchar(500) | NULL | 图片描述 |
| view_count | int | NOT NULL DEFAULT(0) | 浏览次数 |

#### Tag表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| tag_id | int | PRIMARY KEY IDENTITY | 标签ID |
| tag_name | varchar(50) | NOT NULL | 标签名称 |

#### Tag_index表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| img_id | int | PRIMARY KEY, FOREIGN KEY | 图片ID |
| tag_id | int | PRIMARY KEY, FOREIGN KEY | 标签ID |

#### Tag_Statistics表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| stat_id | int | PRIMARY KEY IDENTITY | 统计ID |
| tag_id | int | FOREIGN KEY | 标签ID |
| use_count | int | DEFAULT(1) | 使用次数 |
| last_used | datetime | DEFAULT(getdate()) | 最后使用时间 |

#### Comment表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| comment_id | int | PRIMARY KEY | 评论ID |
| comment_content | varchar(500) | NOT NULL | 评论内容 |
| comment_release_time | date | NULL | 发布时间 |
| user_id | int | FOREIGN KEY | 评论用户ID |
| img_id | int | FOREIGN KEY | 评论图片ID |

#### Favorite表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| favorite_id | int | PRIMARY KEY | 收藏记录ID |
| user_id | int | FOREIGN KEY | 用户ID |
| img_id | int | FOREIGN KEY | 图片ID |

#### FavoriteFolder表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| folder_id | int | PRIMARY KEY IDENTITY | 收藏夹ID |
| user_id | int | FOREIGN KEY | 用户ID |
| folder_name | nvarchar(50) | NOT NULL | 收藏夹名称 |
| folder_description | nvarchar(200) | NULL | 收藏夹描述 |
| folder_order | int | DEFAULT(0) | 排序序号 |
| create_time | datetime | DEFAULT(getdate()) | 创建时间 |
| update_time | datetime | DEFAULT(getdate()) | 更新时间 |
| is_default | bit | DEFAULT(0) | 是否默认 |
| is_deleted | bit | DEFAULT(0) | 是否删除 |
| last_used_time | datetime | DEFAULT(getdate()) | 最后使用时间 |

#### ImageFavoriteFolder表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| img_id | int | PRIMARY KEY, FOREIGN KEY | 图片ID |
| folder_id | int | PRIMARY KEY, FOREIGN KEY | 收藏夹ID |
| img_order | int | DEFAULT(0) | 图片排序 |
| add_time | datetime | DEFAULT(getdate()) | 添加时间 |

#### View_History表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| view_id | int | PRIMARY KEY IDENTITY | 浏览记录ID |
| img_id | int | FOREIGN KEY | 图片ID |
| user_id | int | FOREIGN KEY | 用户ID |
| view_time | datetime | DEFAULT(getdate()) | 浏览时间 |

#### UserSimilarity表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| user_id1 | int | PRIMARY KEY, FOREIGN KEY | 用户1 ID |
| user_id2 | int | PRIMARY KEY, FOREIGN KEY | 用户2 ID |
| similarity_score | float | NOT NULL | 相似度分数 |
| update_time | datetime | NOT NULL | 更新时间 |

#### ImageSimilarity表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| img_id1 | int | PRIMARY KEY, FOREIGN KEY | 图片1 ID |
| img_id2 | int | PRIMARY KEY, FOREIGN KEY | 图片2 ID |
| similarity_score | float | NOT NULL | 相似度分数 |
| update_time | datetime | NOT NULL | 更新时间 |

#### UserRecommendations表

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| user_id | int | PRIMARY KEY, FOREIGN KEY | 用户ID |
| img_id | int | PRIMARY KEY, FOREIGN KEY | 图片ID |
| score | float | NOT NULL | 推荐分数 |
| update_time | datetime | NOT NULL | 更新时间 |

### 3.5 数据库索引设计

为了提高系统查询性能，设计了以下索引：

1. **主键索引**：所有表的主键自动创建聚集索引
2. **外键索引**：所有外键关系自动创建非聚集索引
3. **查询优化索引**：
   - Image表上的user_id字段创建索引，优化按用户查询图片
   - Tag_index表上的tag_id字段创建索引，优化按标签查询图片
   - View_History表上的user_id和view_time字段创建复合索引，优化浏览历史查询
   - FavoriteFolder表上的user_id字段创建索引，优化用户收藏夹查询
   - Comment表上的img_id字段创建索引，优化图片评论查询

## 4. 系统主要模块实现

### 4.1 用户认证模块

```python
@login_bp.route('/login', methods=['GET', 'POST'])
def login():
    """用户登录功能"""
    if request.method == 'POST':
        # 获取表单数据
        username = request.form.get('username')
        password = request.form.get('password')
        
        # 验证用户凭据
        connection_string = config(False)
        cn = pyodbc.connect(connection_string)
        cursor = cn.cursor()
        
        cursor.execute("SELECT user_id, user_password, admin FROM Users WHERE user_name = ?", username)
        user = cursor.fetchone()
        
        if user and user[1] == password:
            # 创建用户会话
            session['user_id'] = user[0]
            session['username'] = username
            session['admin'] = bool(user[2])
            return redirect(url_for('main.main'))
        
        flash('用户名或密码错误！')
        return redirect(url_for('login.login'))
    
    return render_template('login.html')
```

### 4.2 推荐系统模块

```python
@recommend_bp.route('/recommend')
def recommend():
    """个性化推荐页面路由"""
    # 检查用户是否登录
    if 'user_id' not in session:
        flash('请先登录')
        return redirect(url_for('login.login'))
    
    user_id = session['user_id']
    connection_string = config(session.get('admin', False))
    cn = pyodbc.connect(connection_string)
    cursor = cn.cursor()
    
    try:
        # 获取推荐图片
        cursor.execute("""
            SELECT i.*, r.score
            FROM Image i
            JOIN UserRecommendations r ON i.img_id = r.img_id
            WHERE r.user_id = ?
            ORDER BY r.score DESC
        """, user_id)
        
        images = cursor.fetchall()
        
        # 获取每张图片的收藏状态
        image_favorited_status = {}
        for image in images:
            img_id = image[0]
            image_favorited_status[img_id] = is_image_like(user_id, img_id, cursor)
        
        return render_template('recommend.html', 
                             images=images,
                             image_favorited_status=image_favorited_status)
                             
    except Exception as e:
        print(f"获取推荐列表时出错: {str(e)}")
        flash('获取推荐列表时出错')
        return redirect(url_for('main.main'))
        
    finally:
        cn.close()
```

## 5. 结论

本章对多功能图片收藏和管理系统进行了详细的系统设计，包括系统总体架构、系统类图和数据库设计。系统采用分层设计，将表现层、应用逻辑层和数据持久层清晰分离，提高了系统的模块化程度和可维护性。在类图设计中，我们定义了系统的核心类及其关系，为系统的实现提供了清晰的指导。数据库设计遵循第三范式原则，保证了数据的一致性和完整性，同时通过合理的索引设计提高了系统的查询性能。

这些设计为系统的实现提供了坚实的基础，确保了系统能够满足用户对图片收藏、管理、分享和推荐等多方面的需求。 